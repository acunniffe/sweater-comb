# JSON:API "The Good Parts", subset of JSON:API adopted by API.next

functions:
  - assertObjectPath

rules:
  # JSON:API

  ## Content type

  jsonapi-response-content-type:
    description: Responses must provide a JSON:API content type
    message: 'JSON:API requires "Content-Type: application/vnd.api+json"'
    severity: error
    given: $.paths[?(!@property.match(/\/(openapi|sarif)(\/.*)?$/))][*].responses[*].content
    then:
      field: 'application/vnd.api+json'
      function: truthy

  ## Response schema

  ### Structure of 200 responses

  jsonapi-get-post-response-data:
    description: JSON:API response schema requires data property
    message: '{{description}}'
    severity: error
    given: $.paths[?(!@property.match(/\/openapi/))][?(@property.match(/get|post/))].responses[?(@property.match(/200|201/))].content['application/vnd.api+json']
    then:
      function: assertObjectPath
      functionOptions:
        path: [schema, properties, data, type]

  jsonapi-response-jsonapi:
    description: JSON:API response schema requires jsonapi property
    message: '{{description}}'
    severity: error
    given: $.paths[?(!@property.match(/\/openapi/))][*].responses[?(@property.match(/200|201/))].content['application/vnd.api+json']
    then:
      function: assertObjectPath
      functionOptions:
        path: [schema, properties, jsonapi, type]

  jsonapi-get-post-response-data-schema:
    description: JSON:API response data schema
    message: '{{error}}'
    severity: error
    given: $.paths[?(!@property.match(/\/openapi/))][?(@property.match(/get|post/))].responses[?(@property.match(/200|201/))].content['application/vnd.api+json'].schema.properties
    then:
      field: data
      function: schema
      functionOptions:
        schema:
          oneOf:
            - type: object
              properties:
                type:
                  type: string
                  enum: [array]
                items:
                  type: object
                  properties:
                    properties:
                      type: object
                      properties:
                        id:
                          type: object
                          properties:
                            type:
                              type: string
                              enum: [string]
                            format:
                              type: string
                              enum: [uuid]
                          required: [type, format]
                        type:
                          type: object
                          properties:
                            type:
                              type: string
                              enum: [string]
                          required: [type]
                      required: [id, type]
                  required: [properties]
            - type: object
              properties:
                properties:
                  type: object
                  properties:
                    id:
                      type: object
                      properties:
                        type:
                          type: string
                          enum: [string]
                        format:
                          type: string
                          enum: [uuid]
                      required: [type, format]
                    type:
                      type: object
                      properties:
                        type:
                          type: string
                          enum: [string]
                      required: [type]
                  required: [id, type]
              required: [properties]

  jsonapi-post-response-201:
    description: 'Post responses must respond with a 201 status code on success'
    severity: error
    given: $.paths[*].post.responses
    then:
      - field: '@key'
        function: pattern
        functionOptions:
          match: '^201|[3-5][0-9]{2}$'

  ### JsonApi schema

  ### Links schema

  ### Structure of error responses

  ### Error schema

  ### Info message about references (warn without warning)

  ### No includes
